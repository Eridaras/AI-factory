# ğŸš€ Feature Replicator v3.0 - Deep Analysis Engine

**Release Date:** 2025-12-16  
**Architecture:** Multi-layer analysis with AST parsing

---

## ğŸ¯ Objetivo

**AnÃ¡lisis robusto y completo de funcionalidades legacy SIN intervenciÃ³n humana** para replicarlas completamente en nuevos sistemas.

---

## ğŸ—ï¸ Arquitectura de 5 capas

### **Layer 1: Static Analysis (AST + Pattern Matching)** âœ… IMPLEMENTADO

#### PHP AST Analyzer (`ast-analyzer.js`)
Parser basado en `php-parser` que extrae:

**1. Validaciones completas con condiciones anidadas**
```javascript
{
  type: 'if',
  condition: '$estado == "CERRADO" && $monto > 1000',
  then: 'guardar_pedido(); enviar_email()',
  complexity: 1  // nÃºmero de operadores lÃ³gicos
}
```

**2. CÃ¡lculos exactos con fÃ³rmulas**
```javascript
{
  variable: '$rappel',
  formula: '($ventas_netas - $devoluciones) * $porcentaje / 100',
  operations: ['*', '/', '-']
}
```

**3. Manejo de errores (try/catch/throw)**
```javascript
{
  type: 'try-catch',
  catches: [
    { exception_type: 'PDOException', handler: 'rollback(); log_error()' }
  ]
}
```

**4. Transiciones de estado**
```javascript
{
  field: '$pedido->estado',
  new_value: 'CERRADO',
  line: 245
}
```

**5. Dependencias de funciones**
```javascript
{
  function: 'calcular_rappel',
  arguments_count: 3,
  line: 180
}
```

#### Extensibilidad para otros lenguajes
```javascript
export function createASTAnalyzer(language) {
  switch (language) {
    case 'php': return new PHPASTAnalyzer();
    case 'java': return new JavaASTAnalyzer();      // TODO
    case 'csharp': return new CSharpASTAnalyzer();  // TODO
    case 'python': return new PythonASTAnalyzer();  // TODO
    case 'javascript': return new JSASTAnalyzer();  // TODO
  }
}
```

---

### **Layer 2: Database Reverse Engineering** ğŸ”œ PRÃ“XIMA VERSIÃ“N

IntrospecciÃ³n automÃ¡tica de schema:
- Foreign keys y relaciones (1:N, N:M)
- Constraints (NOT NULL, UNIQUE, CHECK)
- Triggers y stored procedures
- Ãndices (hints de performance)

**Resultado esperado:**
```json
{
  "tables": {
    "CLIENTE": {
      "columns": {
        "CLNT_ID": { "type": "INT", "pk": true },
        "NOMBRE": { "type": "VARCHAR(100)", "nullable": false }
      },
      "relationships": {
        "facturas": { "table": "FACTURA", "type": "1:N", "fk": "CLNT_ID" }
      }
    }
  }
}
```

---

### **Layer 3: Dynamic Analysis (Execution Tracing)** ğŸ”œ VERSIÃ“N FUTURA

- Generar datos sintÃ©ticos realistas
- Ejecutar cÃ³digo con instrumentaciÃ³n
- Capturar flujo real + valores
- Detectar side effects

**Resultado esperado:**
```json
{
  "execution_trace": {
    "input": { "target_clnt_id": 12345 },
    "steps": [
      { "function": "validar_cliente", "result": true, "duration_ms": 15 },
      { "function": "obtener_datos", "result": { "nombre": "ABC Corp" }, "duration_ms": 45 },
      { "function": "generar_pdf", "result": "certificado_12345.pdf", "duration_ms": 230 }
    ],
    "output": { "file": "certificado_12345.pdf", "size_kb": 345 }
  }
}
```

---

### **Layer 4: AI Semantic Analysis** ğŸ”œ VERSIÃ“N FUTURA

- LLM analiza cÃ³digo + contexto
- Infiere reglas de negocio no evidentes
- Genera documentaciÃ³n narrativa
- Valida consistencia lÃ³gica

---

### **Layer 5: Dependency & Impact Analysis** ğŸ”œ VERSIÃ“N FUTURA

- Grafo de dependencias entre features
- Shared components detection
- Impact analysis (quÃ© rompo si cambio X)

---

## ğŸ†• Novedades v3.0

### 1. Nueva secciÃ³n en Markdown: **AnÃ¡lisis profundo (AST)**

```markdown
## ğŸ”¬ AnÃ¡lisis profundo (AST)

### Validaciones de negocio

#### IF (lÃ­nea 125)
**CondiciÃ³n:** `$estado == "CERRADO" && $facturas_vencidas == 0`
**AcciÃ³n:** permitir_pedido(); enviar_notificacion()
**Complejidad:** 1 operadores lÃ³gicos

### CÃ¡lculos exactos

- **$rappel** = `($ventas_totales * $porcentaje / 100) - $anticipos` (lÃ­nea 234)
  - Operaciones: *, /, -

### Manejo de errores

- **try-catch** (lÃ­nea 180): catch PDOException: rollback(); log_error()

### Transiciones de estado

- **$pedido->estado** â†’ `ENVIADO` (lÃ­nea 245)
- **$pedido->estado** â†’ `CERRADO` (lÃ­nea 298)

### Dependencias de funciones

- `calcular_rappel` con 3 argumentos (lÃ­nea 180)
- `generar_pdf` con 2 argumentos (lÃ­nea 245)
- `enviar_email` con 4 argumentos (lÃ­nea 267)
```

### 2. Estructura de datos enriquecida en `scan_feature`

Ahora retorna:
```javascript
{
  // ... campos existentes v2.2 ...
  
  deep_analysis: {
    validations: [
      {
        type: 'if',
        condition: '$estado == "CERRADO"',
        action: 'guardar_pedido(); enviar_email()',
        line: 125,
        complexity: 0
      }
    ],
    calculations: [
      {
        variable: '$rappel',
        formula: '($ventas * $porcentaje) / 100',
        operations: ['*', '/'],
        line: 234
      }
    ],
    error_handling: [...],
    state_transitions: [...],
    function_dependencies: [...]
  }
}
```

---

## ğŸ“Š ComparaciÃ³n: v2.2 â†’ v3.0

| Aspecto | v2.2 (Business Semantics) | v3.0 (Deep Analysis) |
|---------|---------------------------|----------------------|
| **Validaciones** | Solo detecta `if (estado == 'CERRADO')` | Extrae condiciÃ³n completa: `$estado == "CERRADO" && $monto > 1000 && $facturas_vencidas == 0` |
| **CÃ¡lculos** | "CÃ¡lculo de rappel como %" | FÃ³rmula exacta: `($ventas_netas - $devoluciones) * ($porcentaje + $bonus) / 100 - $anticipos` |
| **Errores** | No se documentan | `try-catch PDOException: rollback(); log_error()` |
| **Estados** | No se documentan | `$pedido->estado: BORRADOR â†’ ENVIADO â†’ CERRADO` |
| **Dependencias** | No se documentan | `calcular_rappel(3 args) â†’ generar_pdf(2 args) â†’ enviar_email(4 args)` |

---

## ğŸ¯ Casos de uso resueltos

### Certificado Rappel con cÃ¡lculo completo

**v2.2:**
```markdown
## Reglas de negocio
- [CALCULATION] CÃ¡lculo de rappel como porcentaje de ventas
```

**v3.0:**
```markdown
## Reglas de negocio
- [CALCULATION] CÃ¡lculo de rappel como porcentaje de ventas

## ğŸ”¬ AnÃ¡lisis profundo (AST)

### CÃ¡lculos exactos
- **$rappel_base** = `$ventas_totales * $porcentaje_base / 100` (lÃ­nea 180)
- **$bonus_volumen** = `$rappel_base * 1.15` if `$ventas_totales > 50000` (lÃ­nea 185)
- **$rappel_final** = `$rappel_base + $bonus_volumen - $anticipos` (lÃ­nea 190)
  - Operaciones: *, /, +, -

### Validaciones de negocio

#### IF (lÃ­nea 175)
**CondiciÃ³n:** `$ventas_totales > 0 && $estado_cliente == "ACTIVO"`
**AcciÃ³n:** calcular_rappel()
**Complejidad:** 1 operador lÃ³gico

#### IF (lÃ­nea 185)
**CondiciÃ³n:** `$ventas_totales > 50000`
**AcciÃ³n:** $bonus_volumen = $rappel_base * 1.15
```

Ahora puedes **replicar la fÃ³rmula exacta** sin adivinar.

---

## ğŸš€ CÃ³mo usar v3.0

### 1. InstalaciÃ³n (ya hecho)
```bash
cd mcp
npm install php-parser
```

### 2. Uso desde Claude Desktop

```
Reinicia Claude Desktop y usa:

scan_feature con feature_id de un certificado o rappel
```

Ahora verÃ¡s la nueva secciÃ³n **"AnÃ¡lisis profundo (AST)"** con:
- Validaciones completas (condiciones + acciones)
- FÃ³rmulas exactas de cÃ¡lculos
- Try/catch detectados
- Transiciones de estado
- Dependencias de funciones

### 3. Verificar en Markdown exportado

```markdown
*Documento generado automÃ¡ticamente por feature-replicator MCP v3.0 (Deep Analysis Engine)*
```

---

## ğŸ”§ Extensibilidad

### AÃ±adir soporte para Java

```javascript
// ast-analyzer.js
import javaParser from 'java-parser';

class JavaASTAnalyzer extends ASTAnalyzer {
  constructor() {
    super('java');
    this.parser = new javaParser.Parser();
  }
  
  analyze(code) {
    const ast = this.parser.parse(code);
    // Extraer validaciones, cÃ¡lculos, etc.
  }
}
```

### AÃ±adir soporte para C#

```javascript
// ast-analyzer.js
import { parse } from '@angular-eslint/template-parser'; // o roslyn

class CSharpASTAnalyzer extends ASTAnalyzer {
  constructor() {
    super('csharp');
  }
  
  analyze(code) {
    // Parser de C# AST
  }
}
```

---

## ğŸ“ˆ Roadmap v3.x

### v3.1: Database Reverse Engineering
- IntrospecciÃ³n automÃ¡tica de schema
- Relaciones FK automÃ¡ticas
- Constraints y triggers

### v3.2: Dynamic Analysis
- GeneraciÃ³n de datos sintÃ©ticos
- EjecuciÃ³n instrumentada
- Tracing de flujo real

### v3.3: AI Semantic Analysis
- LLM analiza cÃ³digo
- Infiere reglas no evidentes
- Genera narrativa

### v3.4: Dependency Graph
- Grafo completo de dependencias
- Impact analysis
- Shared components

---

## ğŸ“ Ventajas sobre v2.2

1. **FÃ³rmulas exactas**: No mÃ¡s "cÃ¡lculo de rappel como %", ahora: `($ventas * $porcentaje) / 100 - $anticipos`
2. **Validaciones completas**: No mÃ¡s "if estado", ahora: `$estado == "CERRADO" && $monto > 1000 && !$facturas_vencidas`
3. **Manejo de errores**: Ahora detecta try/catch y quÃ© hace en cada excepciÃ³n
4. **Estados**: Documenta transiciones `BORRADOR â†’ ENVIADO â†’ CERRADO`
5. **Dependencias**: Grafo de llamadas entre funciones
6. **Sin regex**: AST parsing es mÃ¡s robusto que regex

---

## ğŸ”¬ TecnologÃ­as

- **php-parser**: Parser AST para PHP 7/8
- **Future**: java-parser, @babel/parser (JS/TS), ast (Python), roslyn (C#)

---

## ğŸ“ ComparaciÃ³n con herramientas existentes

| Herramienta | Nivel | Limitaciones |
|-------------|-------|--------------|
| **PHPDoc/Doxygen** | BÃ¡sico | Solo lee comentarios |
| **PHP_CodeSniffer** | Estilo | No analiza lÃ³gica |
| **PHPStan/Psalm** | Tipos | No extrae business rules |
| **Feature Replicator v3.0** | **Deep Analysis** | âœ… Extrae todo: lÃ³gica + business + dependencias |

---

**Version:** 3.0 (Deep Analysis Engine - Layer 1)  
**Status:** âœ… Released  
**Next:** v3.1 (Database Reverse Engineering - Layer 2)
